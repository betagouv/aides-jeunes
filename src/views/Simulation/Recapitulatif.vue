<template>
  <form @submit.prevent="onSubmit" class="recapitulatif-form">
    <div>
      <template v-for="(chapter, chapterIndex) in chapters">
        <div
          class="chapter-block"
          :key="chapter.name"
          v-if="chapter.questions.length"
        >
          <h2 class="aj-question">{{ chapter.label }}</h2>
          <template v-for="(question, questionIndex) in chapter.questions">
            <template v-if="question.isChapterSubtitle">
              <div
                :key="`chapter_${chapterIndex}_question_${questionIndex}`"
                class="recapitulatif-row"
              >
                <div v-html="question.label" class="subtitle"></div>
              </div>
            </template>
            <template v-else>
              <div
                :key="`chapter_${chapterIndex}_question_${questionIndex}`"
                class="recapitulatif-row"
              >
                <div class="question-col" v-html="question.label"></div>

                <div
                  class="value-col"
                  v-if="typeof question.value !== 'object'"
                  >{{ question.value }}</div
                >
                <div class="edit-col"
                  ><router-link :to="question.path">Modifier</router-link></div
                >
              </div>
              <template v-if="typeof question.value === 'object'">
                <div
                  :key="`chapter_${chapterIndex}_question_${questionIndex}_obj`"
                  class="recapitulatif-row recapitulatif-row-wrap"
                >
                  <div
                    class="value-cell"
                    v-for="(value, name) in question.value"
                    :key="name"
                  >
                    <div style="font-style: italic">{{ name }} :</div>
                    <div>{{ value }}</div>
                  </div>
                </div>
              </template>
            </template>
          </template>
        </div>
      </template>
    </div>

    <Actions v-bind:onSubmit="onSubmit" />
  </form>
</template>

<script>
import Actions from "@/components/Actions"
import {
  capitalize,
  displayValue,
  executeFunctionOrReturnValue,
} from "@/lib/Utils"
import { SIMPLE_STEPS, COMPLEX_STEPS } from "@/lib/Recapitulatif"
import { ENTITIES_PROPERTIES } from "@/lib/State/steps"

export default {
  name: "Recapitulatif",
  components: {
    Actions,
  },
  computed: {
    activeJourney() {
      return this.$store.getters.getAllSteps.filter((s) => s.isActive)
    },
    chapters() {
      return this.$state
        .chapters(this.$route.path, this.$store.getters.getAllSteps)
        .map((chapter) => {
          return {
            label: chapter.label,
            questions: this.stepPerChapter(chapter.name).reduce(
              (accum, step) => {
                accum.push(
                  ...this.questionsPerStep(step).map((question) => {
                    question.path = step.path
                    return question
                  })
                )
                return accum
              },
              []
            ),
          }
        })
    },
  },
  methods: {
    stepPerChapter(chapterName) {
      return this.activeJourney.filter((step) => step.chapter === chapterName)
    },

    onSubmit() {
      this.$push()
    },

    buildMutualizedQuestion({ question, value, component }) {
      return question
        ? [
            {
              label: capitalize(
                executeFunctionOrReturnValue(question, "question", component)
              ),
              value: displayValue(value, question, component),
            },
          ]
        : []
    },

    questionsPerStep(step) {
      if (SIMPLE_STEPS[step.variable]) {
        return SIMPLE_STEPS[step.variable].bind(this)(step)
      }
      if (step.variable === undefined) {
        const match = Object.keys(COMPLEX_STEPS).find((key) =>
          COMPLEX_STEPS[key].matcher(step)
        )
        if (match) {
          return COMPLEX_STEPS[match].fn.bind(this)(step)
        }
      }

      if (ENTITIES_PROPERTIES[step.entity]) {
        const entity = ENTITIES_PROPERTIES[step.entity].loadEntity({
          ...this,
          params: step,
        })
        return this.buildMutualizedQuestion({
          question: ENTITIES_PROPERTIES[step.entity].STEPS[step.variable],
          value: entity[step.variable],
          component: { ...this, entity },
        })
      } else {
        console.log("### This step is not displayed:", step)
      }
      return []
    },
  },
}
</script>

<style scoped lang="scss"></style>
