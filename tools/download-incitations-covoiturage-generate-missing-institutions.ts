import { Grist } from "../lib/grist"
import fs from "fs"
import path from "path"
import { GristIncitationsCoVoiturageResponse } from "../lib/types/download-incitations-covoiturage.js"
import { missingInstitutionsCovoiturageBenefit } from "./generate-missing-institutions"
import covoiturageBenefitJSON from "../data/benefits/dynamic/incitations-covoiturage.json" assert { type: "json" }
const __dirname = new URL(".", import.meta.url).pathname

const noDownload = process.argv.includes("--no-download")

async function main() {
  let covoiturageBenefit
  if (!noDownload) {
    if (!process.env.GRIST_COVOITURAGE_DOC_ID) {
      throw new Error("Missing GRIST_DOC_COVOITURAGE_ID")
    }
    if (!process.env.GRIST_API_KEY) {
      throw new Error("Missing GRIST_API_KEY")
    }
    const gristAPI = Grist(
      process.env.GRIST_COVOITURAGE_DOC_ID,
      process.env.GRIST_API_KEY
    )

    const user = await gristAPI.getConnectedUser()
    console.log(`Connected as ${user.name}.`)

    //Données issue du fichier en Open Data mais avec des informations supplémentaires sur Grist
    //https://www.data.gouv.fr/fr/datasets/conditions-des-campagnes-dincitation-financiere-au-covoiturage/
    const incitationsCovoiturages: GristIncitationsCoVoiturageResponse =
      await gristAPI.get({
        passager_gratuite: ["Oui"],
        passager_eligible_gratuite: ["Tous"],
        passager_montant_ticket: ["Gratuit%C3%A9"],
        Expire: ["false"],
      })

    covoiturageBenefit = incitationsCovoiturages.records.map((record) => {
      const row = record.fields
      const codeSiren = String(row["code_SIREN"])
      const isNotInstitution = row["n_est_pas_une_collectivite"]
      const type = row["type"]

      let communes
      //gestion des types "autre" / n'est pas une collectivite rassemblant plusieurs codes postaux
      if (type === "autre" && isNotInstitution) {
        switch (codeSiren) {
          case "582056511": //ATMB
            communes = [
              "74205",
              "74050",
              "74056",
              "01160",
              "74104",
              "74055",
              "74137",
              "74037",
              "74288",
              "01435",
              "74111",
              "74131",
              "74109",
              "74088",
              "74156",
              "74150",
              "74052",
              "74266",
              "01091",
              "74124",
              "74169",
              "01205",
              "74202",
              "74216",
              "74259",
              "74229",
              "74168",
              "74012",
              "01087",
              "01082",
              "74138",
              "74270",
              "74142",
              "74306",
              "74136",
              "74256",
              "74061",
              "01215",
              "74311",
              "74239",
              "74015",
              "74158",
              "74153",
              "74148",
              "74313",
              "74196",
              "01033",
              "01300",
              "74070",
              "74234",
              "74173",
              "74290",
              "74164",
              "74182",
              "01399",
              "74296",
              "74060",
              "74083",
              "74100",
              "74062",
              "74036",
              "74181",
              "01308",
              "74240",
              "74106",
              "74312",
              "74085",
              "01174",
              "74258",
              "01173",
              "74089",
              "74217",
              "74211",
              "74008",
              "74242",
              "74213",
              "74280",
              "74022",
              "74257",
              "74303",
              "74185",
              "74026",
              "74116",
              "74224",
              "74281",
              "74232",
              "74152",
              "01204",
              "74009",
              "01313",
              "74075",
              "74004",
              "74273",
              "74282",
              "74068",
              "74163",
              "01118",
              "74098",
              "01354",
              "74171",
              "74183",
              "74096",
              "74278",
              "01180",
              "74064",
              "74208",
              "74310",
              "74076",
              "74245",
              "01158",
              "74236",
              "74285",
              "74099",
              "74298",
              "74120",
              "74210",
              "01035",
              "74029",
              "74139",
              "74129",
              "74121",
              "74212",
              "74201",
              "74233",
              "74299",
              "74250",
              "74195",
              "74295",
              "74220",
              "74077",
              "74097",
              "74102",
              "74228",
              "01044",
              "74157",
              "74190",
              "74054",
              "74079",
              "01081",
              "74014",
              "01109",
              "74226",
              "74072",
              "74179",
              "01269",
              "74090",
              "74178",
              "74252",
              "74304",
              "01298",
              "74069",
              "74118",
              "74024",
              "74081",
              "74243",
              "74078",
              "74206",
              "74166",
              "74002",
              "74123",
              "74108",
              "74262",
              "74160",
              "74193",
              "74020",
              "74187",
              "74144",
              "74235",
              "74043",
              "74272",
              "74143",
              "01153",
              "01104",
              "74198",
              "74159",
              "74105",
              "74021",
              "74065",
              "74038",
              "74291",
              "74254",
              "01143",
              "74302",
              "74048",
              "74051",
              "01397",
              "74145",
              "01210",
              "74265",
              "74059",
              "74261",
              "74084",
              "74197",
              "74016",
              "01152",
              "74013",
              "74006",
              "74176",
              "74011",
              "74177",
              "74003",
              "74204",
              "74122",
              "74086",
              "74025",
              "74222",
              "74066",
              "74067",
              "74221",
              "01407",
              "74253",
              "01436",
              "01257",
              "74074",
              "74215",
              "74294",
              "74186",
              "74260",
              "74110",
              "74133",
              "01189",
              "74103",
              "74135",
              "74007",
              "74101",
              "74040",
              "74223",
              "74199",
              "74209",
              "74241",
              "01071",
              "74005",
              "74128",
              "74189",
              "74094",
              "74194",
              "74147",
              "74140",
              "74219",
              "01114",
              "01274",
              "74071",
              "74042",
              "01135",
              "74130",
              "74244",
              "01247",
              "74264",
              "74087",
              "74010",
              "74309",
              "74126",
              "01401",
              "74019",
              "74275",
              "74107",
              "74049",
              "74267",
              "74305",
              "74044",
              "01209",
              "74082",
              "01281",
              "74307",
              "74027",
              "01103",
              "74184",
              "01413",
              "74268",
              "74053",
              "74180",
              "74315",
              "74301",
              "74112",
              "01360",
              "01448",
              "74031",
              "74314",
              "74018",
              "74080",
              "74276",
              "74162",
              "74284",
              "74174",
              "74269",
              "01288",
              "74293",
              "74263",
              "74167",
              "01357",
              "01078",
              "74045",
              "74093",
            ]
            break
          case "256204165": //artois-mobilites
            communes = [
              "62001",
              "62003",
              "62019",
              "62023",
              "62028",
              "62029",
              "62032",
              "62033",
              "62034",
              "62035",
              "62048",
              "62049",
              "62051",
              "62065",
              "62077",
              "62083",
              "62107",
              "62119",
              "62120",
              "62126",
              "62132",
              "62133",
              "62141",
              "62148",
              "62162",
              "62170",
              "62178",
              "62186",
              "62188",
              "62190",
              "62194",
              "62195",
              "62197",
              "62200",
              "62213",
              "62215",
              "62217",
              "62218",
              "62224",
              "62249",
              "62250",
              "62262",
              "62269",
              "62270",
              "62274",
              "62276",
              "62277",
              "62278",
              "62286",
              "62291",
              "62310",
              "62311",
              "62313",
              "62314",
              "62321",
              "62328",
              "62330",
              "62349",
              "62350",
              "62351",
              "62356",
              "62366",
              "62376",
              "62371",
              "62373",
              "62377",
              "62380",
              "62386",
              "62391",
              "62400",
              "62407",
              "62413",
              "62427",
              "62441",
              "62443",
              "62445",
              "62447",
              "62454",
              "62456",
              "62457",
              "62464",
              "62473",
              "62232",
              "62252",
              "62479",
              "62480",
              "62486",
              "62489",
              "62497",
              "62498",
              "62500",
              "62907",
              "62508",
              "62510",
              "62509",
              "62512",
              "62516",
              "62517",
              "62520",
              "62523",
              "62528",
              "62529",
              "62532",
              "62540",
              "62555",
              "62563",
              "62564",
              "62570",
              "62573",
              "62584",
              "62587",
              "62606",
              "62617",
              "62620",
              "62624",
              "62626",
              "62628",
              "62632",
              "62637",
              "62642",
              "62666",
              "62676",
              "62693",
              "62701",
              "62707",
              "62713",
              "62720",
              "62724",
              "62727",
              "62735",
              "62737",
              "62747",
              "62750",
              "62770",
              "62771",
              "62793",
              "62801",
              "62836",
              "62841",
              "62842",
              "62846",
              "62847",
              "62848",
              "62851",
              "62854",
              "62861",
              "62863",
              "62885",
              "62895",
              "62900",
            ]
            break
        }
      }

      return {
        link: row["lien_page_collectivite"],
        code_siren: codeSiren,
        nom_plateforme:
          row["nom_plateforme"] !== null ? row["nom_plateforme"] : "",
        operateurs: row["operateurs"],
        zone_sens_des_trajets: row["zone_sens_des_trajets"].toLowerCase(),
        conducteur_montant_max_par_mois:
          row["conducteur_montant_max_par_mois"] !== ""
            ? parseFloat(row["conducteur_montant_max_par_mois"])
            : 0,
        conducteur_montant_min_par_passager: parseFloat(
          row["conducteur_montant_min_par_passager"]
        ),
        conducteur_montant_max_par_passager:
          row["conducteur_montant_max_par_passager"] !== ""
            ? parseFloat(row["conducteur_montant_max_par_passager"])
            : 0,
        trajet_longueur_max: row["trajet_longueur_max"],
        trajet_longueur_min: row["trajet_longueur_min"],
        passager_trajets_max_par_mois:
          row["passager_trajets_max_par_mois"] !== ""
            ? parseInt(row["passager_trajets_max_par_mois"])
            : 0,
        n_est_pas_une_collectivite: isNotInstitution,
        type: type,
        communes,
      }
    })
  } else {
    // Récupération de la dernière version collecté depuis Grist
    covoiturageBenefit = covoiturageBenefitJSON
  }

  const countOccurencyCodeSiren = covoiturageBenefit.reduce((a, e) => {
    a[e.code_siren] = ++a[e.code_siren] || 0
    return a
  }, {})

  const duplicateRow = covoiturageBenefit.filter(
    (e) => countOccurencyCodeSiren[e.code_siren]
  )
  if (!duplicateRow.length) {
    if (!noDownload) {
      const incitationJson = path.join(
        __dirname,
        "../data/benefits/dynamic/incitations-covoiturage.json"
      )

      fs.writeFile(
        incitationJson,
        JSON.stringify(covoiturageBenefit, null, 2),
        (err) => {
          if (err) console.log(err)
        }
      )
    }

    missingInstitutionsCovoiturageBenefit(covoiturageBenefit)
  } else {
    console.error("Incitations covoiturage dupliquées", duplicateRow)
  }
}

main()
